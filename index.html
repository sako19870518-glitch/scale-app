<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>スケール変換</title>
<meta http-equiv="Cache-Control" content="no-store" />
<style>
  :root{ --bg:#f5f6f8; --card:#fff; --line:#e3e5ea; --ink:#111; --muted:#666; --btn:#111; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:0 0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);padding:18px}

  .grid2{display:grid;grid-template-columns:1fr 54px 1fr;gap:14px;align-items:center}
  .col{display:flex;flex-direction:column;gap:16px}
  .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
  .lbl{color:var(--muted);font-size:13px}
  input.box{height:48px;border:1px solid var(--line);border-radius:12px;padding:0 12px;font-size:18px;background:#fff}

  .arrow{display:flex;align-items:center;justify-content:center;color:#777}
  .arrow::after{content:"→";font-size:20px}

  .btns{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
  .btn{height:48px;border-radius:12px;border:1px solid var(--line);font-weight:800;font-size:16px;cursor:pointer}
  .btn.ghost{background:#fff}

  .formulaWrap{margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}
  .formula{color:#444;font-size:12px}
  .equation{margin-top:4px;font-weight:800}

  .panel{margin-top:12px;border:1px solid var(--line);border-radius:14px;padding:14px}
  .panel h2{margin:0 0 10px;font-size:14px;color:#555}

  .pad{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .key{height:56px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:18px;font-weight:800;cursor:pointer}
  .key.wide{grid-column:span 2}
  .key.dark{background:#111;color:#fff;border-color:#111}
  .key.red{color:#c0392b}

  @media (max-width:640px){
    .row{grid-template-columns:84px 1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>スケール変換</h1>
  <div class="card">

    <!-- 入力・出力 -->
    <div class="grid2">
      <!-- 左：x -->
      <div class="col">
        <div class="row">
          <div class="lbl">1点目</div>
          <input id="x1" class="box" type="number" inputmode="decimal" placeholder="x1（タップでクリア）" value="4">
        </div>
        <div class="row">
          <div class="lbl">2点目</div>
          <input id="x2" class="box" type="number" inputmode="decimal" placeholder="x2（タップでクリア）" value="20">
        </div>
        <div class="row">
          <div class="lbl">測定値</div>
          <input id="xm" class="box" type="number" inputmode="decimal" placeholder="x（タップでクリア）" value="12">
        </div>
      </div>

      <!-- 中央：矢印 -->
      <div class="arrow"></div>

      <!-- 右：y -->
      <div class="col">
        <div class="row">
          <div class="lbl">&nbsp;</div>
          <input id="y1" class="box" type="number" inputmode="decimal" placeholder="y1（タップでクリア）" value="0">
        </div>
        <div class="row">
          <div class="lbl">&nbsp;</div>
          <input id="y2" class="box" type="number" inputmode="decimal" placeholder="y2（タップでクリア）" value="100">
        </div>
        <div class="row">
          <div class="lbl">&nbsp;</div>
          <input id="ym" class="box" type="text" placeholder="結果 y（自動）" value="50" readonly>
        </div>
      </div>
    </div>

    <!-- 操作：クリアだけ残す -->
    <div class="btns">
      <button id="btnClear" class="btn ghost">クリア</button>
    </div>

    <!-- 式（自動更新） -->
    <div class="formulaWrap">
      <div id="formulaLine" class="formula">
        式：a=(y2−y1)/(x2−x1), b=y1−a·x1, 結果=a·測定値+b
      </div>
      <div id="equationLine" class="equation"></div>
    </div>

    <!-- テンキー -->
    <div class="panel">
      <h2>テンキー（選択中の入力欄に反映）</h2>
      <div class="pad">
        <button class="key">7</button>
        <button class="key">8</button>
        <button class="key">9</button>
        <button class="key" data-act="bk" title="Backspace">⌫</button>

        <button class="key">4</button>
        <button class="key">5</button>
        <button class="key">6</button>
        <button class="key" data-act="sgn">±</button>

        <button class="key">1</button>
        <button class="key">2</button>
        <button class="key">3</button>
        <button class="key" data-act="ce" title="Clear Entry">C</button>

        <button class="key wide">0</button>
        <button class="key">.</button>
        <button class="key dark" data-act="ok">OK</button>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const el = {
    x1: $("#x1"), y1: $("#y1"),
    x2: $("#x2"), y2: $("#y2"),
    xm: $("#xm"), ym: $("#ym"),
    formula: $("#formulaLine"), eq: $("#equationLine"),
    btnClear: $("#btnClear")
  };

  // ===== 入力枠：フォーカスで自動クリア =====
  //   - どの枠も、選択（focus）した瞬間に value を消す
  //   - 直後のテンキー/キーボード入力がそのまま入る
  [el.x1,el.y1,el.x2,el.y2,el.xm].forEach(e=>{
    e.addEventListener("focus", () => {
      e.select();          // 一応ハイライト
      e.value = "";        // そして即クリア
      updateAll();         // 再計算
      current = e;         // テンキー入力先
    });
  });

  // ===== テンキーの入力先（最後に触った要素） =====
  let current = el.x1;
  [el.x1,el.y1,el.x2,el.y2,el.xm].forEach(e=>{
    e.addEventListener("focus", ()=> current=e);
  });

  const num = v => {
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : null;
  };
  const fmt = n => Number.isFinite(n) ? (Math.round(n*10000)/10000).toString() : "";

  function computeAB(){
    const x1=num(el.x1.value), y1=num(el.y1.value);
    const x2=num(el.x2.value), y2=num(el.y2.value);
    if([x1,y1,x2,y2].some(v=>v===null)) return null;
    if(x2===x1) return {err:"x2 と x1 が同じ（割り算不可）"};
    const a=(y2-y1)/(x2-x1);
    const b=y1-a*x1;
    return {a,b,x1,y1,x2,y2};
  }

  function updateFormulaOnly(ab, xm){
    if(!ab){
      el.formula.textContent = "式：a=(y2−y1)/(x2−x1), b=y1−a·x1, 結果=a·測定値+b";
      el.eq.textContent = "";
      return;
    }
    if(ab.err){ el.formula.textContent = ab.err; el.eq.textContent=""; return; }

    // y = ax + b
    el.eq.textContent = `y = ${fmt(ab.a)}x + ${fmt(ab.b)}`;

    // 具体式
    let text = `式：a=(${ab.y2}−${ab.y1})/(${ab.x2}−${ab.x1})=${fmt(ab.a)}, `
             + `b=${ab.y1}−${fmt(ab.a)}·${ab.x1}=${fmt(ab.b)}`;
    if(xm!==null){
      const y = ab.a*xm + ab.b;
      text += `, 結果=${fmt(ab.a)}·${xm}+${fmt(ab.b)}=${fmt(y)}`;
    }else{
      text += `, 結果=a·測定値+b`;
    }
    el.formula.textContent = text;
  }

  function updateAll(){
    const ab = computeAB();
    const xm = num(el.xm.value);
    // 結果の自動計算
    if(ab && !ab.err && xm!==null){
      el.ym.value = fmt(ab.a*xm + ab.b);
    }else{
      el.ym.value = "";
    }
    // 式の表示
    updateFormulaOnly(ab, xm);
  }

  // 入力のたびに自動再計算
  [el.x1,el.y1,el.x2,el.y2,el.xm].forEach(e=>{
    e.addEventListener("input", updateAll);
    e.addEventListener("change", updateAll);
  });

  // クリア
  el.btnClear.addEventListener("click", ()=>{
    [el.x1,el.y1,el.x2,el.y2,el.xm,el.ym].forEach(e=>e.value="");
    updateAll();
    el.x1.focus();
  });

  // テンキー
  document.querySelectorAll(".key").forEach(k=>{
    k.addEventListener("click", ()=>{
      if(!current || current.readOnly) return;
      const act = k.dataset.act;
      if(!act){
        const t = k.textContent.trim();
        if(t==="." && current.value.includes(".")) return;
        current.value += t;
      }else{
        if(act==="bk") current.value = current.value.slice(0,-1);
        if(act==="ce") current.value = "";
        if(act==="sgn"){
          if(current.value.startsWith("-")) current.value = current.value.slice(1);
          else current.value = current.value?("-"+current.value):"-";
        }
        if(act==="ok") current.blur();
      }
      updateAll();
    });
  });

  // 初期表示（デフォルト値で一度計算）
  updateAll();
})();
</script>
</body>
</html>
